[TOC]



# 安装系统

## 系统安装及基本设置

可以直接在VPS后台直接安装默认提供的系统，安装之后，要是不能设置SWAP分区的话，建议手动添加，详情参考：https://www.vultr.com/docs/setup-swap-file-on-linux

### 安装自定义centOS系统

Vultr除了提供预安装的系统外，还可以自定义ISO安装系统。

- 先找VPS附近的centOS镜像：https://www.centos.org/download/mirrors/，在vultr后台添加\下载ISO文件（DVD1）;
- 选择配置,进行deploy,先安装vultr自带的系统;
- 进入案例（Instance）-Setting-CustomeISO-Attach ISO and Reboot-View Console，安装**minimal**，
- 分区参考: swap=2倍内存; boot=200M; 其他全部给`/`即可;
- 安装之后可以使用`lsblk`查看硬盘分区（list block），

### 启动网卡

使用`ifconfig`查看启用的网卡(`ifconfig -a`查看所有网卡)，倘若没有**eth0**,说明没有启用,执行`ifup eth0`即可。

注意：此时只是临时开启网卡eth0，重启电脑的话，eth0便会关闭，可以在以下文件中看到，网卡配置文件并没有改：

`vi /etc/sysconfig/network-scripts/ifcfg-eth0`

查看22端口是否正常
` netstat -ntlp`



### 安装常用软件

- 安装vim

```sh
yum list | grep vim
yum install vim-enhanced #其实可以直接 yum install vim
```

`vim .vimrc` 添加如下配置文件

```sh
set nu
syntax on                                                                                  
set showmatch #匹配括号
set cursorline #高亮行
```

- 安装lrzsz

- 安装man\man-pages

- 安装mlocate -记得updatedb

- 安装tree



### 更新系统



``` sh
cat /etc/issue #查看系统版本
yum clean all #清空yum缓存，yum安装时会把软件包和header存储在cache中，大多在/var/cache/yum中，而不自动删除。如果觉得占用磁盘空间，yum clean all一全部清除。
yum makecache #生成缓存
yum upgrade #开始更新软件、系统，但是不更新内核（而update还会更新内核，慎用！！）
```



### 修改ip地址、网关、主机名、DNS #eth0 网卡设置

网卡配置

```sh
cp /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth0.bak #养成备份原文件的习惯
vi /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0 #网卡设备名称
HWADDR=00:0C:29:D0:C7:B5 #以太网设备的对应的物理地址
TYPE=Ethernet #网络类型为以太网模式
UUID=080a457b-6a53-4a3a-9155-a23c1146c2c6 #通用唯一识别码
ONBOOT=yes #是否启动引导的时候激活YES
NM_CONTROLLED=no #设备eth0是否可以由Network Manager图形管理工具托管
BOOTPROTO=dhcp #dhcp表示自动获取IP地址;VPS不能设置static 静态IP，实验证明设置静态后，无法上网。
IPADDR=192.168.1.10 #IP
IPV6INIT=no
IPV6_AUTOCONF=no
NETMASK=255.255.255.0 #网卡对应的网络掩码
GATEWAY=192.168.1.1 #网关地址
```

网关配置

```sh
vi /etc/sysconfig/network
#表示系统是否使用网络，一般设置为yes。如果设为no，则不能使用网络，而且很多系统服务程序将无法启动
NETWORKING=yes
#设置本机的主机名，这里设置的主机名要和/etc/hosts中设置的主机名对应
HOSTNAME=c65mini.localdomain
#设置本机连接的网关的IP地址。例如，网关为10.0.0.1或者192.168.1.1
GATEWAY=192.168.1.1
```

修改主机DNS

```sh
vi /etc/resolv.conf #内容如下:
; generated by /sbin/dhclient-script
nameserver 8.8.8.8
nameserver 4.4.4.4
```

修改HOSTS

```sh
vi /etc/hosts #如下：
127.0.0.1 lvtao.localdomain
#使用DNS域名服务器来解析名字
order bind hosts
#一台主机是否存在多个IP
multi on
#如果用逆向解析找出与指定的地址匹配的主机名，对返回的地址进行解析以确认它确实与您查询的地址相配。为了防止“骗取”IP地址
nospoof on
```

重启网卡生效设置两种方法

```sh
service network restart
或者
/etc/init.d/network restart
```



### 关闭selinux，清空iptables 

在开启selinux的情况下，会限制很多服务器配置。**在服务器配置完全成功后各项服务正常后，再开启selinux。**

**查看selinux状态**

- 第一种方法：/usr/bin/setstatus -v #如果显示：SELinux status: enabled 就是开启状态
- 第二种方法：cat /etc/selinux/config #如果显示：SELINUX=enforcing 则是开启状态permissive有提醒的状态 disabled是关闭
- 第三种方法：grep SELINUX=disabled /etc/selinux/config
- 第四种方法：getenforce

**修改selinux状态**

如果修改配置文件则永久生效，但是必须要重启系统

- 第一种：vi /etc/selinux/config 修改 SELINUX=disabled
- 第二种：sed –i ‘s/SELINUX=enforcing/SELINUX=disabled/g’ /etc/selinux/config

如果想立即生效（如果想临时性的改变） setenforce 0
setenforce 1 设置SELinux 成为enforcing模式 setenforce 0 设置SELinux 成为permissive模式 查看状态 getenforce

iptables防火墙规则清理了，根据需求定制;

*iptables命令是Linux上常用的防火墙软件，是netfilter项目的一部分。可以直接配置，也可以通过许多前端和图形界面配置。*

```sh
1、重启后永久性生效：
chkconfig iptables on #开启
chkconfig iptables off #关闭

2、即时生效，重启后失效：
service iptables start #开启
service iptables stop #关闭
service iptables restart #重启

在开启了防火墙时，做如下设置，开启相关端口，修改 /etc/sysconfig/iptables 文件，添加以下内容：
-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT   #允许80端口通过防火墙
-A INPUT -m state --state NEW -m tcp -p tcp --dport 3306 -j ACCEPT   #允许3306端口通过防火墙
 
```

## 系统优化及安全配置

### 精简开机自启动服务

可以禁用的服务参考网页：http://ponyjia.blog.51cto.com/917324/1860403

**注意:**  如果是中文的话。可能会需要LANG=en 或者替换 3:on 成 3:启用

```sh
#或者
chkconfig --list|grep 3:on
auditd         	0:off	1:off	2:on	3:on	4:on	5:on	6:off
blk-availability	0:off	1:on	2:on	3:on	4:on	5:on	6:off
crond          	0:off	1:off	2:on	3:on	4:on	5:on	6:off
ip6tables      	0:off	1:off	2:on	3:on	4:on	5:on	6:off
iptables       	0:off	1:off	2:on	3:on	4:on	5:on	6:off
kdump          	0:off	1:off	2:off	3:on	4:on	5:on	6:off
mdmonitor      	0:off	1:off	2:on	3:on	4:on	5:on	6:off
netfs          	0:off	1:off	2:off	3:on	4:on	5:on	6:off
network        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
postfix        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
rsyslog        	0:off	1:off	2:on	3:on	4:on	5:on	6:off
sshd           	0:off	1:off	2:on	3:on	4:on	5:on	6:off
udev-post      	0:off	1:on	2:on	3:on	4:on	5:on	6:off
#开启需要的服务
sudo chkconfig kdump on # off 关闭
```

### 设置系统字符集

第一种：`vi /etc/sysconfig/i18n`

修改内容：如果想用中文提示：LANG="zh_CN.UTF-8" 如果想用英文提示：LANG="en_US.UTF-8"

如果临时切换也可以直接在Bash输入命令：LANG=zh_CN.UTF-8

第二种：使用sed快速替换

```sh
#替换成英文
sed -i 's#LANG="zh_CN.*"#LANG="en_US.UTF-8"#' /etc/sysconfig/i18n
#替换成中文
sed -i 's#LANG="en_US.*"#LANG="zh_CN.UTF-8"#' /etc/sysconfig/i18n
#替换成UTF-8中文
sed -i 's#LANG="zh_CN.*"#LANG="zh_CN.UTF-8"#' /etc/sysconfig/i18n
```



### 创建普通用户并进行sudo授权管理

创建用户，并修改密码：

```sh
useradd xxx #添加用户
passwd xxx #修改用户xxx的密码
```

对xxx用户进行授权，修改 /etc/sudoers 文件

```sh
90 ## Allow root to run any commands anywhere
91 root    ALL=(ALL)       ALL
92 yaro    ALL=(ALL)       ALL #添加此行
```

对xxx授权完毕后，可以用xxx帐号登录，然后用命令 `sudo –` ，即可获得root权限进行操作。



### 修改SSH端口号和屏蔽root账号远程登陆

```sh
cp /etc/ssh/sshd_config sshd_config_bak #进入文件夹，备份SSH配置
vi /etc/ssh/sshd_config #修改SSH安全配置 
port 1985 #SSH链接默认端口
PermitRootLogin no #禁止root账号登陆
PermitEmptyPasswords no#禁止空密码
UseDNS no #不使用DNS
```

**切记：修改SSH端口后，防火墙一定要放行此端口。**

重新载入SSH配置 /etc/init.d/sshd reload 查看端口里面是否有刚才修改过的端口号

```sh
netstat -lnt
或者反查端口是那个进程
lsof -i tcp:52113 #centos6.5最小化安装没有lsof工具需要 yum install lsof
```



### 锁定关键文件系统（禁止非授权用户获得权限）

一定要设置好之后再执行如下命令，否则很多程序无法正常安装配置：如mysql-server安装时需要添加mysql用户和用户组；执行如下命令之后，便不能添加了。

```sh
chattr +i /etc/passwd  # i：不得任意更动文件或目录；
chattr +i /etc/inittab
chattr +i /etc/group
chattr +i /etc/shadow
chattr +i /etc/gshadow
```



### 清理登陆的时候显示的系统及内核版本

```sh
#查看登陆信息 
cat /etc/redhat-release 
cat /etc/issue 
#清理登陆信息
echo >/etc/redhat-release 
echo >/etc/issue
```



### 内核参数优化 vi /etc/sysctl.conf

这是一个在网络上流传已久的sysctl.conf优化配置

参考网页：	https://wsgzao.github.io/post/sysctl/ 有简要解释

​			http://www.ha97.com/4396.html 有详细解释

最后记得刷新立即生效`/sbin/sysctl -p`

### 关闭重启ctl-alt-delete组合键

inux默认允许任何人按下Ctrl+Alt+Del来重启系统。但是在生产环境中，应该停用按下Ctrl-Alt-Del 重启系统的功能。会linux的技术牛们都知道前面的centos版本都是在/etc/inittab中配置，它会告诉你Ctrl+Alt+Del这个功能键在哪里设置。

```sh
vi /etc/init/control-alt-delete.conf
#注释掉一下这句：
exec /sbin/shutdown -r now "Control-Alt-Delete pressed"
```



# 安装LEMP

参考网站：
LEMP on RedHat/CentOS: https://serversforhackers.com/video/lemp-on-redhatcentos
Web Server Guides: https://www.linode.com/docs/web-servers/

- 首先明确CMS的“系统要求和安装”，主要相关组件及版本要求；

- 由于使用源码编译安装，需要先安装开发者编译工具

  ```sh
  yum groupinstall "Development Tools"
  ```

  ​

## LEMP原理

- Nginx本身不能处理PHP，它只是个web服务器。当用户通过Browser访问服务器，Nginx（apache）就会以http协议进行解析。如果是静态页面的话，nginx自身处理，然后把结果返回给客户端。如果是是动态网页（index.php)， Nginx便交给PHP解释器（CGI）处理，FastCGI是升级版的CGI；PHP-FPM(FastCGI Process Manager)监听9000端口，Nginx将数据通过9000端口传给PHP-FPM，处理后再返回给Nginx，Nginx再返回给Browser展现给用户；

- 众所周知，PHP是跨平台、跨服务器的语言，这也是它如此流行的原因之一。但是，很少有人知道PHP解释器可以以不同的方式运行在Web服务器中。

  - PHP最常用的方式是以模块的方式(mod_php)运行在Apache中，也是Apache运行PHP的默认方式。
  - Nginx下php解释器使用最多的就是fastcgi。一般情况nginx把php请求转发给fastcgi管理进程处理，fastcgi管理进程选择cgi子进程进行处理，然后把处理结果返回给nginx。

- 在LEMP处理的过程中牵涉到两个用户，一个是nginx运行的用户，一个是php-fpm运行的用户。如果访问的是一个静态文件的话，则只需要nginx运行的用户对文件具有读权限或者读写权限。

  而如果访问的是一个php文件的话，则首先需要nginx运行的用户对文件有读取权限，读取到文件后发现是一个php文件，则转发给php-fpm，此时则需要php-fpm用户对文件具有有读权限或者读写权限。

  详细的用户、用户做说明请访问：[nginx、php-fpm、mysql用户权限解析](http://www.ilanni.com/?p=7438)


## yum安装LEMP

参考网站:
LEMP on RedHat/CentOS: https://serversforhackers.com/video/lemp-on-redhatcentos

```sh
cat /etc/redhat-release
sestatus
sudo setenforce 0 #临时关闭selinux

yum search epel
yum install epel-release

yum search nginx
yum info nginx #查询nginx安装的php版本
yum install nginx
rpm -rl nginx #查看nginx安装到哪儿去了
service nginx start
service nginx status
chkconfig nginx on
curl localhost #或者访问ip地址


#可以通过添加第三方源下载不同版本的PHP，参考网站：https://wiki.centos.org/zh/AdditionalResources/Repositories
yum info php 
yum install php php-mysqlnd php-pdo \
                 php-mbstring php-mcrypt \
                 php-curl php-fpm
rpm -rl php
service php-fpm start
service php-fpm status
chkconfig php-fpm on
vim /etc/php.ini #修改为cgi.fix_pathinfo=0，为了安全

#添加MariaDB库，参考官网：https://downloads.mariadb.org/mariadb/repositories
#添加MariaDB库时，可以选择不同的Linux发行版，一级MariaDB的版本。
yum search mariadb
yum install MariaDB-server
rpm -ql MariaDB-server #查看MariaDB-server安装到哪些目录
rpm -ql MariaDB-server | grep init.d #查看对应服务的名称
service mysql start
service mysql status
chkconfig mysql on
chkconfig --list #查看所有服务的开机启动情况
mysql_secure_installation #初始化数据库，yum安装自动添加$PATH环境变量，可以用locate搜索
```



## 源码包\二进制包 安装LEMP

### Nginx

- 编译安装

参考网页：

http://nginx.org/en/docs/


```sh
./configure 
make
make install

--prefix=/usr/local/nginx.x.x.x
--with-http_ssl_module #使用https协议模块。默认情况下，该模块没有被构建。前提是openssl与openssl-devel已安装
--with-http_stub_status_module #用来监控 Nginx 的当前状态
--with-http_gzip_static_module #是针对 nginx serve 的静态文件，需要编译进去才能有
--with-http_realip_module # 通过这个模块允许我们改变客户端请求头中客户端IP地址值(例如X-Real-IP 或 X-Forwarded-For)，意义在于能够使得后台服务器记录原始客户端的IP地址
--with-http_sub_module #允许用一些其他文本替换nginx响应中的一些文本

/usr/local/nginx/sbin/nginx -V #nginx编译参数查询-v是查看Nginx版本信息

```


- Nginx添加服务，开机启动

```sh
#添加一个nginx服务,内容参考官网文档：https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/ 和https://www.linode.com/docs/web-servers/lemp/lemp-server-on-centos-6
vim /etc/init.d/nginx 
#记得修改nginx执行程序的路径：nginx=”/usr/local/nginx/sbin/nginx”,修改成配置文件的位置 NGINX_CONF_FILE=”/usr/local/nginx/conf/nginx.conf” 
#此时便可以用service管理nginx了
service nginx start
#用chkconfig管理开机启动,chkconfig调用/etc/init.d/目录下的服务。
chkconfig --add nginx
chkconfig --level 3 nginx on
chkconfig --list #查询开机启动项
```



### PHP

务必参考官网：https://secure.php.net/manual/zh/install.unix.nginx.php

另外编译是有很多参数，需要根据需要好好研究下，yum也可以通过相关的配置文件来实现同样的功能。



### MySQL 

MySQL安装为什么大部分使用二进制安装。而不是源码手动去编译？

MySQL使用的glibc进行开发的。glibc库是一个底层api,所以只要是Linux，都会有glibc库。所以，MySQL安装不需要考虑环境是否符合要求，移植性很方便。直接将编译好的二进制代码复制到另外一个机器上表可以使用。

所以MySQL建议使用二进制安装，倘若不介意使用新版本的话，yum安装也是极好的。

**二进制包安装**

参考：http://blog.csdn.net/acrux1985/article/details/70052392

参考官网：https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html

